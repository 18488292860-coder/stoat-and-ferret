openapi: "3.1.0"
info:
  title: stoat-and-ferret API
  description: >
    AI-driven video editor REST API. The Python/FastAPI layer handles HTTP routing and
    orchestration; compute-intensive operations (timeline math, filter generation,
    input sanitization) are delegated to the Rust core via PyO3 bindings.
  version: "0.6.0"
  license:
    name: MIT

servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  /health/live:
    get:
      operationId: liveness
      summary: Liveness probe
      tags: [Health]
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: ok

  /health/ready:
    get:
      operationId: readiness
      summary: Readiness probe with dependency checks
      tags: [Health]
      responses:
        "200":
          description: All dependencies healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
        "503":
          description: One or more dependencies degraded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"

  /api/v1/videos:
    get:
      operationId: listVideos
      summary: List videos with pagination
      tags: [Videos]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated video list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VideoListResponse"

  /api/v1/videos/search:
    get:
      operationId: searchVideos
      summary: Search videos by filename or path (FTS5 full-text search)
      tags: [Videos]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VideoSearchResponse"

  /api/v1/videos/{video_id}:
    get:
      operationId: getVideo
      summary: Get video by ID
      tags: [Videos]
      parameters:
        - $ref: "#/components/parameters/VideoId"
      responses:
        "200":
          description: Video details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VideoResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      operationId: deleteVideo
      summary: Delete video from library
      tags: [Videos]
      parameters:
        - $ref: "#/components/parameters/VideoId"
        - name: delete_file
          in: query
          description: Also delete source file from disk
          schema:
            type: boolean
            default: false
      responses:
        "204":
          description: Video deleted
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/videos/{video_id}/thumbnail:
    get:
      operationId: getVideoThumbnail
      summary: Get thumbnail image for a video
      tags: [Videos]
      parameters:
        - $ref: "#/components/parameters/VideoId"
      responses:
        "200":
          description: JPEG thumbnail image
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/videos/scan:
    post:
      operationId: scanDirectory
      summary: Submit directory scan as async job
      description: >
        Path validation is performed synchronously by the Rust core before job
        submission. Returns a job_id for polling via GET /api/v1/jobs/{job_id}.
      tags: [Videos]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScanRequest"
      responses:
        "202":
          description: Scan job submitted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobSubmitResponse"
        "400":
          description: Invalid path
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Path not in allowed scan roots
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/projects:
    get:
      operationId: listProjects
      summary: List all projects
      tags: [Projects]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated project list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectListResponse"
    post:
      operationId: createProject
      summary: Create a new project
      tags: [Projects]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProjectCreate"
      responses:
        "201":
          description: Project created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResponse"

  /api/v1/projects/{project_id}:
    get:
      operationId: getProject
      summary: Get project by ID
      tags: [Projects]
      parameters:
        - $ref: "#/components/parameters/ProjectId"
      responses:
        "200":
          description: Project details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      operationId: deleteProject
      summary: Delete project
      tags: [Projects]
      parameters:
        - $ref: "#/components/parameters/ProjectId"
      responses:
        "204":
          description: Project deleted
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/projects/{project_id}/clips:
    get:
      operationId: listClips
      summary: List clips in project (ordered by timeline position)
      tags: [Clips]
      parameters:
        - $ref: "#/components/parameters/ProjectId"
      responses:
        "200":
          description: Clip list for project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClipListResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    post:
      operationId: addClip
      summary: Add clip to project
      description: >
        Path validation and time range validation are performed by the Rust core
        before the clip is persisted.
      tags: [Clips]
      parameters:
        - $ref: "#/components/parameters/ProjectId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClipCreate"
      responses:
        "201":
          description: Clip added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClipResponse"
        "400":
          description: Validation error (clip fails Rust validation)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/projects/{project_id}/clips/{clip_id}:
    patch:
      operationId: updateClip
      summary: Update clip
      tags: [Clips]
      parameters:
        - $ref: "#/components/parameters/ProjectId"
        - $ref: "#/components/parameters/ClipId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClipUpdate"
      responses:
        "200":
          description: Clip updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClipResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      operationId: deleteClip
      summary: Delete clip
      tags: [Clips]
      parameters:
        - $ref: "#/components/parameters/ProjectId"
        - $ref: "#/components/parameters/ClipId"
      responses:
        "204":
          description: Clip deleted
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/jobs/{job_id}:
    get:
      operationId: getJobStatus
      summary: Get job status
      description: >
        Poll status of an async job submitted via POST /api/v1/videos/scan or
        POST /api/v1/effects/{effect_type}/apply.
      tags: [Jobs]
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobStatusResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/effects:
    get:
      operationId: listEffects
      summary: List all available effects with parameter schemas and AI hints
      description: >
        Returns all registered effects from the EffectRegistry. Each effect
        includes a JSON Schema for parameters, per-parameter AI guidance strings,
        and a filter_preview showing the FFmpeg filter string generated by the
        corresponding Rust builder.
      tags: [Effects]
      responses:
        "200":
          description: Available effects
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EffectListResponse"

  /api/v1/effects/{effect_type}:
    get:
      operationId: getEffect
      summary: Get a single effect definition by type
      tags: [Effects]
      parameters:
        - $ref: "#/components/parameters/EffectType"
      responses:
        "200":
          description: Effect definition
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EffectDefinitionResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/effects/{effect_type}/apply:
    post:
      operationId: applyEffect
      summary: Apply an effect to a clip (enqueues job)
      description: >
        Applies a named effect to a clip. The filter string is generated by the
        corresponding Rust builder (DrawtextBuilder for text_overlay, SpeedControl
        for speed_control). Input text is automatically sanitized by the Rust core.
        The effect configuration is stored in the clip's effects_json field.
        Returns a job_id; poll GET /api/v1/jobs/{job_id} for completion.
      tags: [Effects]
      parameters:
        - $ref: "#/components/parameters/EffectType"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EffectApplyRequest"
      responses:
        "202":
          description: Effect application job submitted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EffectApplyResponse"
        "400":
          description: Invalid effect type or parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          $ref: "#/components/responses/NotFound"

components:
  parameters:
    VideoId:
      name: video_id
      in: path
      required: true
      schema:
        type: string
    ProjectId:
      name: project_id
      in: path
      required: true
      schema:
        type: string
    ClipId:
      name: clip_id
      in: path
      required: true
      schema:
        type: string
    EffectType:
      name: effect_type
      in: path
      required: true
      description: "Effect type identifier (e.g. text_overlay, speed_control)"
      schema:
        type: string
        example: text_overlay

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    VideoResponse:
      type: object
      required: [id, path, filename, duration_frames, frame_rate_numerator, frame_rate_denominator, width, height, video_codec, file_size, created_at, updated_at]
      properties:
        id:
          type: string
        path:
          type: string
        filename:
          type: string
        duration_frames:
          type: integer
        frame_rate_numerator:
          type: integer
        frame_rate_denominator:
          type: integer
        width:
          type: integer
        height:
          type: integer
        video_codec:
          type: string
        audio_codec:
          type: string
          nullable: true
        file_size:
          type: integer
        thumbnail_path:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    VideoListResponse:
      type: object
      required: [videos, total, limit, offset]
      properties:
        videos:
          type: array
          items:
            $ref: "#/components/schemas/VideoResponse"
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    VideoSearchResponse:
      type: object
      required: [videos, total, query]
      properties:
        videos:
          type: array
          items:
            $ref: "#/components/schemas/VideoResponse"
        total:
          type: integer
        query:
          type: string

    ScanRequest:
      type: object
      required: [path]
      properties:
        path:
          type: string
        recursive:
          type: boolean
          default: true

    ProjectCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
        output_width:
          type: integer
          minimum: 1
          default: 1920
        output_height:
          type: integer
          minimum: 1
          default: 1080
        output_fps:
          type: integer
          minimum: 1
          maximum: 120
          default: 30

    ProjectResponse:
      type: object
      required: [id, name, output_width, output_height, output_fps, created_at, updated_at]
      properties:
        id:
          type: string
        name:
          type: string
        output_width:
          type: integer
        output_height:
          type: integer
        output_fps:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProjectListResponse:
      type: object
      required: [projects, total]
      properties:
        projects:
          type: array
          items:
            $ref: "#/components/schemas/ProjectResponse"
        total:
          type: integer

    ClipCreate:
      type: object
      required: [source_video_id, in_point, out_point, timeline_position]
      properties:
        source_video_id:
          type: string
        in_point:
          type: integer
          minimum: 0
          description: In point in frames (frame-accurate, validated by Rust core)
        out_point:
          type: integer
          minimum: 0
          description: Out point in frames (frame-accurate, validated by Rust core)
        timeline_position:
          type: integer
          minimum: 0
          description: Timeline position in frames

    ClipUpdate:
      type: object
      properties:
        in_point:
          type: integer
          minimum: 0
          nullable: true
        out_point:
          type: integer
          minimum: 0
          nullable: true
        timeline_position:
          type: integer
          minimum: 0
          nullable: true

    ClipResponse:
      type: object
      required: [id, project_id, source_video_id, in_point, out_point, timeline_position, created_at, updated_at]
      properties:
        id:
          type: string
        project_id:
          type: string
        source_video_id:
          type: string
        in_point:
          type: integer
        out_point:
          type: integer
        timeline_position:
          type: integer
        effects_json:
          type: string
          nullable: true
          description: JSON array of applied effects with filter strings
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ClipListResponse:
      type: object
      required: [clips, total]
      properties:
        clips:
          type: array
          items:
            $ref: "#/components/schemas/ClipResponse"
        total:
          type: integer

    JobSubmitResponse:
      type: object
      required: [job_id]
      properties:
        job_id:
          type: string

    JobStatusResponse:
      type: object
      required: [job_id, status]
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [PENDING, RUNNING, COMPLETE, FAILED, TIMEOUT]
        progress:
          type: number
          nullable: true
        result: {}
        error:
          type: string
          nullable: true

    ReadinessResponse:
      type: object
      required: [status, checks]
      properties:
        status:
          type: string
          enum: [ok, degraded]
        checks:
          type: object
          required: [database, ffmpeg]
          properties:
            database:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                latency_ms:
                  type: number
                error:
                  type: string
            ffmpeg:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                version:
                  type: string
                error:
                  type: string

    EffectParameterSchema:
      description: JSON Schema object describing effect parameters
      type: object
      additionalProperties: true

    EffectDefinitionResponse:
      type: object
      required: [effect_type, name, description, parameter_schema, ai_hints, filter_preview]
      properties:
        effect_type:
          type: string
          example: text_overlay
        name:
          type: string
          example: Text Overlay
        description:
          type: string
          example: Add styled text overlay with position presets
        parameter_schema:
          $ref: "#/components/schemas/EffectParameterSchema"
        ai_hints:
          type: object
          additionalProperties:
            type: string
          description: Per-parameter natural language guidance strings for AI clients
          example:
            text: "The text content to display on screen"
            position: "Use bottom_center for subtitles, center for titles"
        filter_preview:
          type: string
          description: Sample FFmpeg filter string generated by the Rust builder
          example: "drawtext=text='Sample Text':fontsize=48:fontcolor=white:x=(w-text_w)/2:y=h-text_h-20"

    EffectListResponse:
      type: object
      required: [effects, total]
      properties:
        effects:
          type: array
          items:
            $ref: "#/components/schemas/EffectDefinitionResponse"
        total:
          type: integer
          example: 2

    EffectApplyRequest:
      type: object
      required: [clip_id, parameters]
      properties:
        clip_id:
          type: string
          description: ID of the clip to apply the effect to
        parameters:
          type: object
          additionalProperties: true
          description: Effect parameters matching the effect's parameter_schema
          example:
            text: "Chapter 1: Introduction"
            fontsize: 64
            fontcolor: white
            position: center

    EffectApplyResponse:
      type: object
      required: [job_id, effect_type, filter_string]
      properties:
        job_id:
          type: string
          description: Job ID for polling via GET /api/v1/jobs/{job_id}
        effect_type:
          type: string
          example: text_overlay
        filter_string:
          type: string
          description: >
            FFmpeg filter string generated by the Rust builder. Special characters
            are automatically escaped by the Rust sanitizer.
          example: "drawtext=text='Chapter 1\\: Introduction':fontsize=64:fontcolor=white:x=(w-text_w)/2:y=(h-text_h)/2"

    ErrorResponse:
      type: object
      required: [detail]
      properties:
        detail:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              enum:
                - NOT_FOUND
                - INVALID_INPUT
                - INVALID_PATH
                - INVALID_TIME_RANGE
                - UNSUPPORTED_FORMAT
                - EFFECT_NOT_FOUND
                - INVALID_EFFECT_PARAMS
                - UNSAFE_INPUT
                - FFMPEG_ERROR
                - RUST_CORE_ERROR
                - INTERNAL_ERROR
            message:
              type: string
            suggestion:
              type: string
            validated_by:
              type: string
              enum: [rust_core, python]
